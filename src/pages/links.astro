---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Main from "@/layouts/Main.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { SITE } from "@/config";
import { UI } from "@/i18n/ui";
import { parseLinkCards } from "@/utils/parseLinkCards";
import { optimizeImage } from "@/utils/optimizeImages";

const linkDocs = await getCollection("links", ({ data }) => !data.draft);

const normalizeText = (value?: string) => value?.trim().toLowerCase() ?? "";
const pageTitleNormalized = normalizeText(UI.pages.linksTitle);
const pageDescNormalized = normalizeText(UI.pages.linksDesc);

const sortedDocs = [...linkDocs].sort(
  (a, b) => (a.data.order ?? 0) - (b.data.order ?? 0)
);

const sections = (
  await Promise.all(
    sortedDocs.map(async doc => {
      const parsedCards = parseLinkCards(doc.body ?? "");
      const cards = await Promise.all(
        parsedCards.map(async card => {
          if (!card.image) return card;
          const optimized = await optimizeImage(card.image, { thumbnailSize: 600 });
          return { ...card, image: optimized.thumbnail };
        })
      );

      return {
        title: doc.data.title,
        description: doc.data.description,
        cards,
      };
    })
  )
).filter(section => section.cards.length > 0);

const hasMultipleSections = sections.length > 1;
---

<Layout title={`${UI.pages.linksTitle} | ${SITE.title}`}>
  <Header />
  <Main pageTitle={UI.pages.linksTitle} pageDesc={UI.pages.linksDesc}>
    {
      sections.length === 0 ? (
        <p class="text-skin-base/70">{UI.pages.linksEmpty}</p>
      ) : (
        <div class="space-y-10">
          {
            sections.map(section => (
              <section>
                {(() => {
                  const sectionTitle = section.title?.trim();
                  const sectionDesc = section.description?.trim();
                  const isDuplicateWithPageHeader =
                    normalizeText(sectionTitle) === pageTitleNormalized &&
                    normalizeText(sectionDesc) === pageDescNormalized;
                  const showSectionHeader =
                    hasMultipleSections ||
                    (!isDuplicateWithPageHeader && Boolean(sectionTitle || sectionDesc));

                  return (
                    showSectionHeader && (
                      <header class="mb-4">
                        {sectionTitle && (
                          <h2 class="text-2xl font-semibold">{sectionTitle}</h2>
                        )}
                        {sectionDesc && (
                          <p class="text-skin-base/70 mt-1 text-sm">
                            {sectionDesc}
                          </p>
                        )}
                      </header>
                    )
                  );
                })()}

                <ul class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                  {section.cards.map(card => (
                    <li>
                      <a
                        href={card.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="group border-skin-line/60 bg-skin-card/30 block h-full overflow-hidden rounded-2xl border transition hover:-translate-y-0.5 hover:border-accent/60"
                      >
                        {card.image && (
                          <img
                            src={card.image}
                            alt={card.title}
                            class="h-36 w-full object-cover"
                            loading="lazy"
                          />
                        )}
                        <div class="p-4">
                          <h3 class="text-lg font-semibold">{card.title}</h3>
                          {card.description && (
                            <p class="text-skin-base/75 mt-2 text-sm leading-relaxed">
                              {card.description}
                            </p>
                          )}
                          <p class="text-accent mt-3 text-xs font-medium">
                            {UI.pages.linksVisit} â†’
                          </p>
                        </div>
                      </a>
                    </li>
                  ))}
                </ul>
              </section>
            ))
          }
        </div>
      )
    }
  </Main>
  <Footer />
</Layout>
